require('dotenv').config();
const express = require('express');
const jwt = require('jsonwebtoken');
const { performance } = require('perf_hooks');

const app = express();
app.use(express.json());

const PORT = process.env.PORT || 3000;
const AUTH_MODE = (process.env.AUTH_MODE || 'static').toLowerCase();
const STATIC_BEARER_TOKEN = process.env.STATIC_BEARER_TOKEN || 'changeme-token';
const JWT_SECRET = process.env.JWT_SECRET || 'changeme-jwt-secret';
const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '1h';

function truncate(str, n = 200) {
  if (!str) return '';
  return str.length > n ? str.slice(0, n) + '...<truncated>' : str;
}

function loggerMiddleware(req, res, next) {
  const start = performance.now();
  const { method, url, headers } = req;
  const clientIp = headers['x-forwarded-for'] || req.socket.remoteAddress;
  let safeBody = '';
  if (req.body && Object.keys(req.body).length > 0) {
    try {
      safeBody = truncate(JSON.stringify(req.body));
    } catch (e) {
      safeBody = '<unserializable body>';
    }
  }
  res.on('finish', () => {
    const durationMs = (performance.now() - start).toFixed(2);
    const log = {
      ts: new Date().toISOString(),
      ip: clientIp,
      method,
      url,
      status: res.statusCode,
      durationMs,
      body: safeBody,
    };
    console.log(JSON.stringify(log));
  });
  next();
}

app.use(loggerMiddleware);

function unauthorized(res, message = 'Unauthorized') {
  return res.status(401).json({ error: message });
}

function bearerAuthMiddleware(req, res, next) {
  const authHeader = req.headers['authorization'] || '';
  if (!authHeader.startsWith('Bearer ')) {
    return unauthorized(res, 'Missing or malformed Authorization header');
  }
  const token = authHeader.slice('Bearer '.length).trim();
  if (!token) return unauthorized(res, 'Empty token');
  if (AUTH_MODE === 'static') {
    if (token === STATIC_BEARER_TOKEN) {
      req.user = { type: 'static', tokenId: 'static-token-user' };
      return next();
    }
    return unauthorized(res, 'Invalid token');
  }
  if (AUTH_MODE === 'jwt') {
    try {
      const payload = jwt.verify(token, JWT_SECRET);
      req.user = payload;
      return next();
    } catch (err) {
      return unauthorized(res, 'Invalid or expired token');
    }
  }
  return unauthorized(res, 'Auth mode misconfigured');
}

app.get('/health', (req, res) => {
  res.json({ status: 'ok', mode: AUTH_MODE });
});

app.get('/public', (req, res) => {
  res.json({ message: 'This is public. No auth required.' });
});

app.get('/private', bearerAuthMiddleware, (req, res) => {
  res.json({ message: 'This is protected data.', user: req.user || null });
});

app.post('/login', (req, res) => {
  if (AUTH_MODE !== 'jwt') {
    return res.status(400).json({ error: 'Login endpoint only available in jwt mode' });
  }
  const { username } = req.bo
